## 트랜잭션
데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 단위  
데이터베이스 접근 방법은 쿼리이므로, 즉 여러 개의 쿼리들을 하나로 묶는 단위를 말한다.

**ACID** 특징을 가진다.  
원자성(**A**tomicity), 일관성(**C**onsistency), 독립성(**I**solation), 지속성(**D**urability)

### 원자성
> all or nothing

트랜잭션과 관련된 일이 모두 수행되었거나 모두 수행되지 않음을 보장한다.  
대표적 예시: 송금 과정(잔고 조회 - 출금 - 입금)

트랜잭션 단위로 여러 로직을 묶을 때, 외부 API를 호출하는 부분이 있으면 안 된다.  
만약 있다면, 롤백이 일어났을 때 어떻게 해야 할 것인지에 대한 해결 방법이 있어야 하고, *트랜잭션 전파*를 신경써서 관리해야 한다.

#### 커밋과 롤백
커밋과 롤백을 통해 데이터의 무결성이 보장된다.  
또한 데이터 변경 사항을 쉽게 확인할 수 있고, 작업을 그룹화할 수 있다.
* 커밋
	* 여러 쿼리가 성공적으로 처리되었다고 확정하는 명령어다.
	* **트랜잭션 단위**로 수행되며, 변경 내용이 모두 영구적으로 저장된다.
* 콜백
  * 트랜잭션으로 처리한 하나의 묶음 과정을 일어나기 전으로 돌리는 것이다.

#### 트랜잭션 전파
트랜잭션은 *커넥션* 단위로 수행하기 때문에 커넥션 객체를 넘겨서 수행해야 한다. 하지만 매번 넘겨주기에 복잡하기 때문에, 여러 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 하는 것을 트랜잭션 전파라고 한다.  
스프링에서는 `@Transactional` 애너테이션을 통해 여러 쿼리 관련 코드들을 하나의 트랜잭션으로 처리한다.

##### 커넥션
커넥션은 DB와 애플리케이션 간 통신할 수 있도록 하는 것이다.  
일부 DBMS 도구에서는 클라이언트가 데이터베이스에 연결할 때의 세션을 의미하기도 한다. (동일한 것을 사용하더라도 새 커넥션이 됨)

DB 커넥션을 생성할 때, 접근하고자 하는 DB 이름, 위치, 포트, 접근을 위한 자격 증명 정보 등이 필요하다. 또, 커넥션 생성 시 해당 DB가 단일 연결만 허용되는지에 따라 여러 처리들이 진행되어야 한다.

이러한 커넥션의 비용은 실제로 데이터를 가지고 처리하는 비용보다 더 많이 들기 때문에, 보통은 **커넥션 풀(Connection Pool)** 을 사용하여 커넥션을 관리한다. 즉 여러 개의 커넥션을 만들어 두고 풀에 추가해두면, 어플리케이션이 풀에서 연결 요청을 하고, 이를 사용하고 다시 반환하여 재사용함으로써 적은 수의 연결로 많은 데이터베이스 연결 및 처리를 진행할 수 있다.

### 일관성
'허용된 방식'으로만 데이터를 변경해야하는 것을 의미한다.  
즉, 모든 데이터는 여러 조건과 규칙에 따라 유효해야 한다.

### 격리성
트랜잭션 수행 시 서로 끼어들지 못하는 것을 말한다.  
복수의 병렬 트랜잭션은 서로 격리되어 마치 순차적으로 실행되는 것처럼 작동되어야 하고, 데이터베이스는 여러 사용자가 같은 데이터에 접근할 수 있어야 한다.

이러한 연산을 순차적으로 하면 성능 저하가 발생하기에, 여러 개의 격리 수준으로 나뉘어 격리성을 보장한다.
* `SERIALIZABLE` (약한 동시성, 강한 격리성)
* `REPEATABLE_READ`
* `READ_COMMITTED`
* `READ_UNCOMMITTED` (강한 동시성, 약한 격리성)

#### 격리 수준에 따라 발생하는 현상
* 팬텀 리드
* 반복 가능하지 않은 조회
* 더티 리드

##### 팬텀 리드 (phantom read)
한 트랜잭션 내에서 동일한 쿼리를 보냈을 때 해당 조회 결과가 다른 경우

![팬텀 리드](4.3장%20트랜잭션과%20무결성/phantom-read.png)  
위 이미지에서 `Transaction2`를 주목하면, 처음 SELECT의 결과와 두 번째 SELECT 결과가 다르다. 이는 곧 다른 행이 선택될 수도 있다는 것을 의미한다.

##### 반복 가능하지 않은 조회 (non-repeatable read)
한 트랜잭션 내의 같은 행에 두 번 이상 조회가 발생했는데, 그 값이 다른 경우

![반복 가능하지 않은 조회](4.3장%20트랜잭션과%20무결성/non-repeatable-read.png)  
위 이미지에서 `Transaction2`를 주목하면, 첫 SELECT에서 확인한 `id 1`의 값과 두 번째 SELECT에서 확인한 `id 1`의 값이 다르다.

##### 더티 리드 (dirty read)
반복 가능하지 않은 조회와 유사하며, 한 트랜잭션이 실행중일 때 다른 트랜잭션에 의해 수정되었지만 아직 **커밋되지 않은** 행의 데이터를 읽을 수 있을 때 발생한다.

![더티 리드](4.3장%20트랜잭션과%20무결성/dirty-read.png)  
이는 롤백 상황에서 큰 문제가 발생할 수 있다.

![더티 리드 - 롤백 시 상황](4.3장%20트랜잭션과%20무결성/dirty-read-rollback.png)  
다음과 같이 `Transaction 1`에서 수정되었으나, 롤백되어 적용되지 않은 값을 `Transaction 2`에서 읽어들인 후 커밋하게 되면 의도하지 않은 결과가 도출되게 된다.

#### 격리 수준
##### SERIALIZABLE
트랜잭션을 순차적으로 진행시키는 것을 말한다.  
따라서 여러 트랜잭션이 동시에 같은 행에 접근할 수 없다.

매우 엄격한 수준으로, 교착 상태가 일어날 확률도 많고 가장 성능이 떨어지는 격리 수준이다.

##### REPEATABLE_READ
하나의 트랜잭션이 수정한 행을 다른 트랜잭션이 수정할 수 없도록 막는다.  
하지만 새로운 행을 추가하는 것은 막지 않는다.  
(MySQL 8.0의 innoDB 기본값)

따라서, **팬텀 리드**가 발생할 수 있다.

##### READ_COMMITTED
가장 많이 사용되는 격리 수준이며, PostgreSQL, SQL Server, 오라클의 기본 값이다.

커밋 완료된 데이터에 대해서만 조회를 허용한다. 하지만 어떤 트랜잭션이 접근한 행을 다른 트랜잭션이 수정할 수 있다. 즉, 한 트랜잭션 내에서 조회한 행의 값이 변경될 수 있다.

따라서, **팬텀 리드**, **반복 가능하지 않은 조회**가 발생할 수 있다.

##### READ_UNCOMMITTED
가장 낮은 격리 수준으로, 하나의 트랜잭션이 커밋되기 이전에 다른 트랜잭션에 노출될 수 있지만 가장 빠르다.

데이터 무결성을 위해 되도록이면 사용하지 않는 것이 이상적이지만, 몇몇 행이 제대로 조회되지 않더라도 괜찮은 거대한 양의 데이터를 '어림잡아' 집계하는 데 사용하기 좋다.

따라서, **팬텀 리드**, **반복 가능하지 않은 조회**, **더티 리드**가 발생할 수 있다.

### 지속성
성공적으로 수행된 트랜잭션은 영원히 반영되어야 하는 것을 의미한다.  
즉, 데이터베이스에 시스템 장애가 발생해도 원래 상태로 복구하는 회복 기능이 있어야 한다.

데이터베이스는 다음 기능들을 통해 지속성을 보장한다.
* 체크섬
  * 주로 네트워크 트래픽이나 Disk IO에서 자주 사용되는 방식
  * 전송 시, 뒤에 비트 등을 추가하여 수신한 데이터의 손상 여부를 판단하도록 한다.
* 저널링
  * 파일 시스템이 깨지는 등의 장애를 막기 위해 어디까지 정상 처리되었고, 어디부터 재실행하면 되는 지 저널을 남겨두는 것
  * 즉, DB 시스템에서 발생하는 모든 변경 사항을 기록하는 작업
* 롤백

## 무결성
데이터의 정확성, 일관성, 유효성을 유지하는 것을 말한다.  
무결성이 유지되어야 데이터베이스에 저장된 값과 현실 세계의 실제 값이 일치하는지에 대한 신뢰가 생긴다.

무결성의 종류는 다음과 같다.
* 개체 무결성
  * 기본키로 선택된 필드는 빈 값을 허용하지 않는다.
* 참조 무결성
  * 서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지해야 한다.
  * 즉, 기본 키와 참조 키 간의 관계가 항상 유지되어야 한다.
  * 이는 곧 어떤 개체를 참조하는 개체가 있을 경우, 해당 개체는 삭제하지 못하고, 기본키도 변경될 수 없음을 뜻한다.
* 고유 무결성
  * 특정 속성에 대해 고유한 값을 가지는 조건이 있을 경우, 그 속성의 값은 모두 고유한 값을 가진다.
* `NULL` 무결성
  * 특정 속성 값에 `NULL`이 올 수 없다는 조건이 있는 경우, 그 속성 값은 `NULL`이 될 수 없다.


---
## 참고 문헌
https://budibase.com/blog/data/database-connections/
https://medium.com/@sujoy.swe/database-connection-pool-647843dd250b
https://hudi.blog/transaction-isolation-level/